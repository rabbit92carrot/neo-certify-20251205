# 패치 노트 (Changelog)

> Neo-Certify 의료기기 공급망 추적 시스템의 기능 변경 이력입니다.
> 기획/기능 관점에서 작성되었으며, 각 버전은 실제 배포(PR merge) 기준입니다.

---

## v1.7.0 (2026-02-05) — 제품 중복 검증

> PR #41

### 신규 기능
- **UDI-DI 전역 중복 검사**: 제품 등록/수정 시 모든 조직을 대상으로 UDI-DI 고유성 검증
- **모델명 조직 내 중복 검사**: 동일 조직 내 활성 제품에서 모델명 고유성 검증
- **복수 에러 동시 표시**: UDI-DI와 모델명 중복 시 두 에러를 동시에 사용자에게 안내
- **재활성화 시 검증**: 비활성 제품 재활성화 시 동일 모델명의 활성 제품 존재 여부 확인

### 향후 과제
- [ ] 테스트 데이터 정리 후 DB 레벨 unique constraint 추가 필요 (#39)
- [ ] 기존 중복 데이터 정리 (레거시 허용 상태)

---

## v1.6.0 (2026-02-04) — V2 페이지 업그레이드 및 관리자 UI 개선

> PR #33 ~ #38

### 신규 기능
- **출고 페이지 V2** (제조사, 유통사)
  - 실시간 제품 검색 (제품명, 모델명, 별칭)
  - 즐겨찾기 기능 (조직별 최대 20개, localStorage)
  - 전체 제품 다이얼로그 (페이지네이션 + 검색)
- **시술 페이지 V2** (병원)
  - 동일한 검색/즐겨찾기/다이얼로그 기능 적용
- **관리자 Split View UI**
  - 승인 페이지: 좌측 목록 + 우측 사업자등록증 미리보기
  - 회원 관리 페이지: 좌측 목록 + 우측 조직 상세 정보
  - 모바일에서는 Sheet(모달)로 자동 전환
- **알림톡 테스트 페이지** (`/alimtalk-test`)
  - 비밀번호 보호 적용
  - 프로덕션 환경에서도 접근 가능
- **알림톡 다중 발송 API** (`sendAlimtalkBulk`)

### 기능 개선
- 출고 페이지 초기 로딩 속도 개선 (전체 제품 → 상위 12개만 로드, ~4-5s → ~500ms)
- Suspense + `after()` 패턴으로 체감 속도 개선
- 제조사 제품 관리 페이지에 검색/정렬 기능 추가

### 버그 수정
- 로그아웃 시 쿠키 오버플로우 방지 (대량 쿠키 환경에서 로그아웃 실패 현상)
- 로그아웃 API CORS origin 추가 (`neo-certify.vercel.app`)
- SearchableCombobox hydration mismatch 오류 수정

### 향후 과제
- [ ] 출고 V2에서 Lot 선택 기능은 제조사만 지원 — 유통사/병원은 미구현
- [ ] 모바일 해상도에서 Split View Sheet 모달 동작 검증 필요

---

## v1.5.0 (2026-01-29) — 인증 UX 개선

> PR #31, #32

### 신규 기능
- **비밀번호 찾기**: 이메일 입력 → 비밀번호 재설정 링크 발송 → 새 비밀번호 설정
- **계정 찾기**: 이메일 입력으로 가입 여부 확인 (가입한 이메일인지 안내)
- **이메일 인증 대기 화면**: 회원가입 후 이메일 인증 안내 페이지 제공 (재발송 가능)

### 버그 수정
- 비밀번호 재설정 redirectTo URL 수정 (SITE_URL → APP_URL)

### 향후 과제
- [ ] 비밀번호 재설정 이메일 템플릿 커스터마이징
- [ ] 소셜 로그인 연동 (Google, Kakao 등) 고려

---

## v1.4.0 (2026-01-22 ~ 01-28) — 알림톡 연동 및 성능 최적화

> PR #27, #28, #30

### 신규 기능
- **알림톡 서비스** (Aligo API 연동)
  - 시술 완료 시 환자에게 정품 인증 결과 카카오 알림톡 발송
  - Mock/Live 토글 기능 (개발 환경에서는 Mock 모드)
  - 카카오 승인 템플릿(UF_1441) 적용
- **디자인 시스템 페이지** (`/design-system`)
  - 역할별(관리자/제조사/유통사/병원) 페이지 맵 시각화
  - 컴포넌트 카탈로그 및 인터랙티브 프리뷰
  - 컴포넌트 Showcase (Variant, Props 정보)
- **알림 메시지 제품명 집계**: 동일 제품 여러 개 시술 시 "제품A 외 N건"으로 요약 표시

### 기능 개선
- 관리자 대시보드/조직 목록/이력 페이지 응답 속도 개선
- 병원 페이지 병렬 쿼리 및 캐싱 적용
- 시술 이력 통합 조회 RPC (여러 쿼리를 하나의 DB 호출로)
- Lazy Loading 적용 (생산 등록 폼, 출고 폼, 디자인 시스템 캔버스)
- 5,000건 초과 Lot 생성 시 배치 분할 (Cloud 타임아웃 방지)

### 버그 수정
- 비활성 제품 사용 로그 기록 시 타임아웃 오류 수정
- UUID 캐스팅 안전성 개선 (잘못된 UUID 입력 시 크래시 방지)
- 시술 이력 제품 집계 오류 수정

### 향후 과제
- [ ] 알림톡 발송 실패 시 재시도 로직
- [ ] 디자인 시스템과 Storybook 연동
- [ ] 성능 측정 자동화 도구 CI 연동

---

## v1.3.0 (2026-01-21) — 보안 강화

> PR #23, #25

### 신규 기능
- **CSRF 보호**: 로그아웃 API에 CSRF 토큰 검증 추가
- **Rate Limiting**: Upstash 기반 API 요청 제한 (로컬 fallback 포함)
- **SQL 필터 이스케이프**: 사용자 입력 기반 필터에 SQL injection 방지
- **리다이렉트 검증**: 로그아웃 후 리다이렉트 URL 화이트리스트 검증

### 기능 개선
- 접근성(a11y) 개선: ARIA 속성 추가
- DB 익명 역할(anon) 권한 제한

### 버그 수정
- 프로덕션 URL 로그아웃 CSRF 화이트리스트 누락 수정

### 향후 과제
- [ ] CSP(Content Security Policy) 헤더 추가
- [ ] 세션 만료 시간 정책 수립

---

## v1.2.0 (2025-12-30 ~ 2026-01-05) — 코드 정리 및 안정성

> PR #17 ~ #20

### 기능 개선
- 에러 코드 SSOT 통합 (`constants/errors`)
- 로거 마이그레이션 (console.error → 구조화된 logger)
- 검증 에러 포맷 유틸리티 추출

### 버그 수정
- 커서 기반 페이지네이션에서 MAX(UUID) 오류 수정 (이력 조회 시 빈 결과)
- SearchableCombobox: 검색 초기화 후 선택된 옵션이 사라지는 문제 수정
- 날짜 범위 필터: 종료일이 포함되지 않는 문제 수정 (KST 타임존 처리)

### 향후 과제
- [ ] 에러 메시지 다국어 지원 (i18n) 고려

---

## v1.1.0 (2026-01-07) — 폐기 및 반품 기능

> PR #21

### 신규 기능
- **제품 폐기** (병원 전용)
  - 폐기 사유 선택: 시술 중 손실, 유효기간 만료, 제품 불량, 기타
  - FIFO 기반 자동 코드 선택 (오래된 재고부터 자동 폐기)
  - 폐기 이력 조회 지원
- **반품 기능** (유통사, 병원)
  - 수신자가 발송자에게 반품 가능
  - 부분 반품 지원 (일부 제품만 반품 가능)
  - 반품 체인 지원 (A→B→C 출고 시, C→B→A 순서로 반품)
  - 반품 사유 입력 필수 (사유 드롭다운 선택)
- **반품 이벤트 분리**: RETURN_SENT(반품 출고) / RETURN_RECEIVED(반품 입고)로 방향 구분
- **보유 수량 표시**: 거래 이력에서 반품 가능한 수량을 확인 가능

### 기능 개선
- 장바구니/수량 입력 레이아웃 개선 (하단 고정)
- 검색 버튼 UX 개선
- 병원 이력에 폐기(DISPOSED) 이벤트 표시

### 버그 수정
- Toaster 컴포넌트 hydration 불일치 수정

### 향후 과제
- [ ] 리콜(Recall) 기능과 반품 연계
- [ ] 반품 승인 워크플로우 (현재는 즉시 처리)
- [ ] 폐기 승인 프로세스 (현재는 병원에서 바로 폐기 가능)

---

## v1.0.0 (2025-12-23) — 알림톡 Mock 및 정품 인증

> PR #16

### 신규 기능
- **카카오 알림톡 Mock 페이지**: 알림톡 발송/수신 시뮬레이션
- **정품 인증 페이지** (`/verify`): 환자가 QR 코드로 제품 정품 여부 확인
  - 리콜 대상 제품 자동 감지 및 경고 표시
- **고객 문의 페이지** (`/inquiry`): 제품 관련 문의 접수
- **알림 메타데이터**: 시술 완료 알림에 인증 버튼 링크 포함

### 향후 과제
- [ ] 정품 인증 결과 상세 디자인 (현재 기본 UI)
- [ ] 고객 문의 접수 후 처리 플로우

---

## v0.9.0 (2025-12-22) — 병원 제품 관리

> PR #14, #15

### 신규 기능
- **제품 별칭 관리**: 병원에서 자체적으로 사용하는 제품 별칭 설정 가능
- **제품 활성/비활성 관리**: 병원이 사용하지 않는 제품을 비활성화하여 목록에서 제외
- **병원 설정 페이지**: 제품 별칭 및 활성 상태 일괄 관리
- **환자 캐시 테이블**: 자주 내원하는 환자 정보 캐싱으로 검색 속도 향상

### 기능 개선
- 병원 전체 페이지에 제품 별칭 반영 (재고, 시술, 이력 등)
- 환자 전화번호 검색 성능 최적화 (B-tree 인덱스)

### 향후 과제
- [ ] 환자 정보 개인정보 보호 정책 검토
- [ ] 제품 별칭 일괄 등록 (CSV import 등)

---

## v0.8.0 (2025-12-19) — 커서 기반 페이지네이션

> PR #13

### 기능 개선
- **커서 기반 무한 스크롤**: 이력 조회 페이지에서 대량 데이터 처리 개선
  - 관리자 이력, 리콜 목록
  - 제조사/유통사/병원 이력 페이지
- **검색 기능**: SearchableCombobox 컴포넌트로 실시간 검색
- **가상 코드 표시**: UUID 대신 사람이 읽을 수 있는 코드(NC-XXXXXXXX) 표시

### 향후 과제
- [ ] 검색 필터 조합 (날짜 + 키워드 + 조직 등)

---

## v0.7.0 (2025-12-18) — 성능 최적화 및 모니터링

> PR #12

### 신규 기능
- **비활성 제품 사용 모니터링**
  - 비활성화된 제품이 출고/시술에 사용될 경우 자동 알림 생성
  - 비활성화 사유 기록: 단종, 안전 이슈, 품질 이슈, 기타
  - 관리자/제조사 알림 보관함에서 알림 확인
- **HMAC 기반 가상코드 검증**: 시술 시 코드 위변조 방지
- **생산 등록 사용기한 수동 수정**: 자동 계산된 사용기한을 사용자가 직접 수정 가능
- **관리자 이벤트 상세보기**: 이력 테이블에서 이벤트 클릭 시 상세 정보 인라인 확장
- **재고 테이블에 모델명 표시**

### 기능 개선
- 모바일 반응형 레이아웃 (데스크톱 사이드바 + 모바일 Bottom Navigation)
- N+1 쿼리 최적화로 대시보드 로딩 속도 개선
- 모든 페이지에 로딩 스켈레톤 UI 추가

### 버그 수정
- 로그아웃 리다이렉트 URL 프록시 환경 대응
- products RLS 무한재귀 수정
- 관리자 이력 테이블 반응형 레이아웃 깨짐 수정
- Lot 유효기간 계산 시 1일 오차 수정

### 향후 과제
- [ ] 비활성 제품 알림 일괄 확인(읽음) 처리 — 구현 완료
- [ ] 리콜 발생 시 비활성 제품 알림과 연계

---

## v0.6.0 (2025-12-16) — UI 개선

> PR #7 ~ #11

### 기능 개선
- **생산 등록 페이지 UI 변경**: 아코디언 그룹 + 2열 레이아웃 적용
- **모든 페이지 로딩 UI**: 실제 페이지 구조와 일치하는 스켈레톤 UI
- **관리자 조직 이력 상세보기**: 거래이력에서 제품 코드 목록 표시
- **관리자 조직 관리**: 보유 코드 수량 집계 정확도 개선 (IN_STOCK만 카운트)

### 버그 수정
- Lot 번호 생성 시 모델명에서 숫자만 추출하도록 수정
- 출고 대상 목록에서 자기 자신이 표시되는 문제 수정
- 거래이력 중복 생성 버그 수정

---

## v0.5.0 (2025-12-13 ~ 14) — 모바일 대응 및 UX

> PR #1 ~ #6

### 신규 기능
- **Bottom Navigation**: 모바일 환경에서 하단 네비게이션 바 제공
- **반응형 레이아웃**: 데스크톱은 사이드바, 모바일은 하단 네비게이션 자동 전환
- **환자 전화번호 검색 Combobox**: 시술 등록 시 환자를 전화번호로 검색

### 기능 개선
- 페이지 전환 지연시간 최소화
- 조직 관리 페이지 통계 카드 + 페이지네이션 추가

### 버그 수정
- 로그아웃 리다이렉트 연산자 우선순위 버그 수정
- 모바일 하단 네비게이션 텍스트 잘림 문제 해결

---

## v0.4.0 (2025-12-12) — 안정성 및 보안

> 초기 개발 커밋 (PR 이전)

### 기능 개선
- Combobox 컴포넌트 도입 (Select → Combobox 전환)
- 원자적 트랜잭션 함수 도입 (출고/시술 등 복합 작업의 데이터 정합성 보장)
- 조직명 고유성 제약조건 추가 (동일 조직명 등록 방지)
- DB 함수 보안 강화 (SECURITY DEFINER → search_path 고정)
- 테스트 인프라 구축 (단위 테스트, 통합 테스트)

---

## v0.3.0 (2025-12-10) — 관리자 기능 및 이력 조회

> 초기 개발 커밋 (PR 이전)

### 신규 기능
- **관리자 대시보드**: 전체 시스템 현황 조회 (조직 수, 제품 수, 이벤트 수 등)
- **조직 승인 관리**: 신규 가입 조직 승인/거절
- **거래 이력 조회**: 전체 거래 이력 그룹핑 및 조회
- **카카오 알림톡 Mock 페이지**: 알림 발송 시뮬레이션
- **E2E 테스트 환경**: Playwright 기반 E2E 테스트 구축

### 기능 개선
- N+1 쿼리 최적화 (관리자 대시보드)
- 대규모 테스트 데이터 시드 (2,500+ 가상코드)

---

## v0.2.0 (2025-12-08) — 핵심 비즈니스 기능

> 초기 개발 커밋 (PR 이전)

### 신규 기능
- **제조사 기능**
  - 제품 등록 및 관리 (UDI-DI, 모델명, 유효기간 등)
  - Lot 생산 등록 (수량 지정, 가상코드 자동 생성)
  - 유통사/병원으로 출고
  - 재고 현황 조회
- **유통사 기능**
  - 제조사로부터 입고 확인
  - 병원으로 재출고
  - 재고 현황 조회
- **병원 기능**
  - 유통사/제조사로부터 입고 확인
  - 환자 시술 등록 (환자 정보 + 제품 선택)
  - 시술 이력 조회
  - 재고 현황 조회

---

## v0.1.0 (2025-12-05) — 프로젝트 초기 구축

> 초기 개발 커밋 (PR 이전)

### 신규 기능
- **프로젝트 기본 설정**: Next.js 16, React 19, Supabase, shadcn/ui
- **인증 시스템**: Supabase Auth 기반 로그인/회원가입
- **역할 기반 접근 제어**: 제조사/유통사/병원/관리자 4개 역할
- **역할별 대시보드 레이아웃**: 사이드바 네비게이션, 역할별 메뉴 구성

---

## 기능 현황 요약

### 구현 완료
| 영역 | 기능 | 버전 |
|------|------|------|
| **인증** | 로그인/회원가입 | v0.1.0 |
| **인증** | 비밀번호 찾기/계정 찾기 | v1.5.0 |
| **인증** | 이메일 인증 UX | v1.5.0 |
| **제조사** | 제품 등록/관리 | v0.2.0 |
| **제조사** | Lot 생산 등록 | v0.2.0 |
| **제조사** | 출고 (V2: 검색/즐겨찾기) | v0.2.0 → v1.6.0 |
| **제조사** | 제품 중복 검증 (UDI-DI/모델명) | v1.7.0 |
| **유통사** | 입고/재출고 (V2: 검색/즐겨찾기) | v0.2.0 → v1.6.0 |
| **병원** | 시술 등록 (V2: 검색/즐겨찾기) | v0.2.0 → v1.6.0 |
| **병원** | 제품 별칭/활성 관리 | v0.9.0 |
| **병원** | 폐기 기능 | v1.1.0 |
| **공통** | 반품 기능 | v1.1.0 |
| **공통** | 거래 이력 조회 | v0.3.0 |
| **공통** | 재고 현황 조회 | v0.2.0 |
| **관리자** | 조직 승인 관리 | v0.3.0 |
| **관리자** | Split View UI (승인/회원관리) | v1.6.0 |
| **관리자** | 비활성 제품 모니터링 | v0.7.0 |
| **알림** | 카카오 알림톡 (Aligo API) | v1.4.0 |
| **인증** | 정품 인증 페이지 | v1.0.0 |
| **보안** | CSRF, Rate Limiting, SQL escape | v1.3.0 |
| **UI** | 모바일 반응형 (Bottom Nav) | v0.5.0 |
| **UI** | 디자인 시스템 페이지 맵 | v1.4.0 |

### 미구현 / 추가 고려 사항
| 영역 | 항목 | 우선순위 | 비고 |
|------|------|----------|------|
| **DB** | UDI-DI unique constraint | 높음 | 서비스 배포 전 필수 (#39) |
| **인증** | 소셜 로그인 (Google/Kakao) | 중간 | 현재 이메일만 지원 |
| **제조사** | 리콜 관리 기능 | 높음 | 현재 관리자에서만 확인 가능 |
| **반품** | 반품 승인 워크플로우 | 중간 | 현재 즉시 처리 |
| **폐기** | 폐기 승인 프로세스 | 낮음 | 현재 병원에서 바로 처리 |
| **알림** | 알림톡 발송 실패 재시도 | 중간 | |
| **알림** | 알림톡 발송 이력 관리 | 중간 | 현재 로그만 존재 |
| **보안** | CSP 헤더 추가 | 중간 | |
| **보안** | 세션 만료 정책 | 중간 | |
| **UX** | 다국어 지원 (i18n) | 낮음 | 현재 한국어만 |
| **UX** | 검색 필터 고도화 (날짜+키워드+조직) | 중간 | |
| **병원** | 환자 개인정보 보호 정책 | 높음 | 법적 요건 검토 필요 |
| **데이터** | 제품/Lot 일괄 등록 (CSV import) | 중간 | |
| **인프라** | CI/CD 파이프라인 (GitHub Actions) | 중간 | 한 번 추가 후 revert됨 |
| **정품인증** | 인증 결과 상세 페이지 디자인 | 낮음 | 현재 기본 UI |
| **고객** | 고객 문의 접수 후 처리 플로우 | 낮음 | 현재 접수만 가능 |
